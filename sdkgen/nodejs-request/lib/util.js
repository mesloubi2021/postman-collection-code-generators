const codegen = require('postman-code-generators'),
  sdk = require('postman-collection');

/**
 * sanitizes input string by handling escape characters eg: converts '''' to '\'\''
 *
 * @param {String} inputString
 * @returns {String}
 */
function sanitize (inputString) {
  if (typeof inputString !== 'string') {
    return '';
  }
  return inputString.replace(/\\/g, '\\\\').replace(/'/g, '\\\'').replace(/\n/g, '\\n');
}

/**
 * Replaces postman variables( {{variable}} ) in the generated snippet as
 * `' + variable_name + '`
 *
 * @param {String} requestSnippet - Request snipept generated by postman-code-generator
 * @returns {String} - Request snippet string with replaced collection variables
 */
function replaceVariables (requestSnippet) {
  var variableDeclarations = requestSnippet.match(/{{[^{\s\n}]*}}/g);
  if (variableDeclarations !== null) {
    variableDeclarations.forEach((element) => {
      // replacing {{variable_name}} with ' + variable_name + '
      requestSnippet = requestSnippet.replace(element, '\' + ' + element.substring(2, element.length - 2) + ' + \'');
    });
  }
  return requestSnippet;
}

/**
 * Generates snippet for a function declaration

 * @param {sdk.Item} collectionItem - PostmanItem Instance
 * @param {Object} options - postman-code-gen options (for specific language)
 * @param {Function} callback - Callback function to return response  (err, snippet)
 * @returns {String} - returns a snippet of function declaration of of a request
 */
function generateFunctionSnippet (collectionItem, options, callback) {
  let snippet = '',
    variableDeclarations;
  codegen.convert('NodeJs', 'Request', collectionItem.request, options, function (err, requestSnippet) {
    if (err) {
      return callback(err, null);
    }

    variableDeclarations = requestSnippet.match(/{{[^{\s\n}]*}}/g);

    // JSDocs declaration
    snippet += `/**\n${collectionItem.request.description}\n`;
    snippet += '@param {Function} callback - Callback function to return response (err, res)\n';
    variableDeclarations.forEach((element) => {
      let varName = element.substring(2, element.length - 2);
      snippet += `@param {String} variables.${varName}\n`;
    });
    snippet += '*/\n';

    // Function declaration
    snippet += options.ES6_enabled ? '(variables, callback) => {\n' : 'function(variables, callback){\n';

    // Request level variable declaration
    variableDeclarations.forEach((element) => {
      let varName = element.substring(2, element.length - 2);
      snippet += options.ES6_enabled ? 'let ' : 'var ';
      snippet += `${varName} = variables.${varName} ? variables.${varName} : self.environmentVariables.${varName};\n`;
    });

    snippet += replaceVariables(requestSnippet);
    snippet += '}';
    return callback(null, snippet);
  });
}

/**
 * [Description]
 *
 * @param {sdk.Item} collectionItem - Postman Collection Item instance
 * @param {object} options - postman-code-generator options
 * @param {function} callback - function to return result (err, snippet)
 */
function itemHandler (collectionItem, options, callback) {
  let snippet = '';
  generateFunctionSnippet(collectionItem, options, (err, funcSnippet) => {
    if (err) {
      return callback(err, null);
    }
    snippet += `"${collectionItem.name}": \n`;
    snippet += funcSnippet;
    snippet += ',\n';
    return callback(null, snippet);
  });
}

/**
 * [Description]
 *
 * @param {sdk.ItemGroup} collectionItem - Postman Collection Item Member
 * @param {array }memberResults - Array of result after passing through processCollection method for this ItemGroup
 * @param {object} options - postman-code-generators options
 * @param {function} callback - Function to return result (err, result)
 */
function itemGroupHandler (collectionItem, memberResults, options, callback) {
  let snippet = '';
  snippet += `/**\n${collectionItem.description}\n*/\n`;
  snippet += `"${collectionItem.name}": {\n`;
  snippet += memberResults.join('');
  snippet += '},\n';
  return callback(null, snippet);
}

module.exports = {
  sanitize,
  generateFunctionSnippet,
  itemHandler,
  itemGroupHandler,
  replaceVariables
};
